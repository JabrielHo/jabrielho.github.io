---
import { getCollection } from "astro:content";
import InteractiveMap from "./InteractiveMap.astro";

const experiences = (await getCollection("experience")).sort((a, b) => a.data.order - b.data.order);
const education = (await getCollection("education")).sort((a, b) => a.data.order - b.data.order);

const markers = [
  ...experiences.map((e) => ({
    lat: e.data.lat,
    lng: e.data.lng,
    title: e.data.company,
    subtitle: e.data.title,
    date: `${e.data.startDate} — ${e.data.endDate}`,
    type: "work" as const,
  })),
  ...education.map((e) => ({
    lat: e.data.lat,
    lng: e.data.lng,
    title: e.data.institution,
    subtitle: e.data.degree,
    date: `${e.data.startDate} — ${e.data.endDate}`,
    type: "education" as const,
  })),
];
---

<section id="experience" class="py-24 bg-stone-100/50">
  <div class="max-w-7xl mx-auto px-6">
    <div class="animate-on-scroll">
      <span class="font-mono text-xs font-medium uppercase tracking-[3px] text-stone-400 mb-2 block"
        >Experience & Education</span
      >
      <h2 class="text-4xl font-extrabold mb-12 text-stone-800">Where I've worked & studied</h2>
    </div>

    <div class="grid lg:grid-cols-5 gap-10">
      <div class="lg:col-span-3">
        <h3 class="text-sm font-semibold text-stone-400 uppercase tracking-wider mb-6">Work Experience</h3>
        <div class="relative mb-12" role="list" aria-label="Work experience timeline">
          <div class="absolute left-3 top-2 bottom-0 w-px bg-stone-200" aria-hidden="true"></div>
          <div class="space-y-8">
            {
              experiences.map((exp, i) => (
                <div class="animate-on-scroll relative pl-10" style={`transition-delay: ${i * 100}ms`} role="listitem">
                  <div
                    class="absolute left-3 top-2 -translate-x-1/2 w-2.5 h-2.5 rounded-full bg-stone-500 border-[3px] border-stone-100"
                    aria-hidden="true"
                  />

                  <div
                    class="card map-card cursor-pointer group hover:bg-white hover:shadow-md transition-all duration-300"
                    data-lat={exp.data.lat}
                    data-lng={exp.data.lng}
                    aria-label={`${exp.data.title} at ${exp.data.company} — click to view on map`}
                    tabindex="0">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 mb-2">
                      <div>
                        <h4 class="font-bold text-stone-800">{exp.data.title}</h4>
                        <p class="text-stone-500 text-sm font-medium">{exp.data.company}</p>
                      </div>
                      <time class="font-mono text-xs text-stone-400 shrink-0 bg-stone-50 px-2 py-1 rounded-md w-fit">
                        {exp.data.startDate} — {exp.data.endDate}
                      </time>
                    </div>

                    {exp.data.highlights.length > 0 && (
                      <ul class="space-y-1.5 mt-3">
                        {exp.data.highlights.map((h: string) => (
                          <li class="flex items-baseline gap-2 text-stone-500 text-sm leading-relaxed">
                            <span
                              class="w-1 h-1 rounded-full bg-stone-400 shrink-0 translate-y-[-1px]"
                              aria-hidden="true"
                            />
                            <span>{h}</span>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                </div>
              ))
            }
          </div>
        </div>

        <h3 class="text-sm font-semibold text-stone-400 uppercase tracking-wider mb-6">Education</h3>
        <div class="relative" role="list" aria-label="Education timeline">
          <div class="absolute left-3 top-2 bottom-0 w-px bg-stone-200" aria-hidden="true"></div>
          <div class="space-y-8">
            {
              education.map((edu, i) => (
                <div class="animate-on-scroll relative pl-10" style={`transition-delay: ${i * 100}ms`} role="listitem">
                  <div
                    class="absolute left-3 top-2 -translate-x-1/2 w-2.5 h-2.5 rounded-full bg-stone-500 border-[3px] border-stone-100"
                    aria-hidden="true"
                  />

                  <div
                    class="card map-card cursor-pointer group hover:bg-white hover:shadow-md transition-all duration-300"
                    data-lat={edu.data.lat}
                    data-lng={edu.data.lng}
                    aria-label={`${edu.data.degree} at ${edu.data.institution} — click to view on map`}
                    tabindex="0">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-1 mb-2">
                      <div>
                        <h4 class="font-bold text-stone-800">{edu.data.institution}</h4>
                        <p class="text-stone-500 text-sm font-medium">{edu.data.degree}</p>
                      </div>
                      <time class="font-mono text-xs text-stone-400 shrink-0 bg-stone-50 px-2 py-1 rounded-md w-fit">
                        {edu.data.startDate} — {edu.data.endDate}
                      </time>
                    </div>

                    {edu.data.highlights.length > 0 && (
                      <ul class="space-y-1.5 mt-3">
                        {edu.data.highlights.map((h: string) => (
                          <li class="flex items-baseline gap-2 text-stone-500 text-sm leading-relaxed">
                            <span
                              class="w-1 h-1 rounded-full bg-stone-400 shrink-0 translate-y-[-1px]"
                              aria-hidden="true"
                            />
                            <span>{h}</span>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="lg:sticky lg:top-[90px]">
          <div class="animate-on-scroll">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4" aria-label="Map legend">
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full bg-stone-700" aria-hidden="true"></span>
                  <span class="text-xs text-stone-500">Work</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full bg-stone-400" aria-hidden="true"></span>
                  <span class="text-xs text-stone-500">Education</span>
                </div>
              </div>
              <span class="text-xs text-stone-400 italic">Click card to view on map</span>
            </div>

            <div class="rounded-2xl overflow-hidden border border-stone-200 shadow-sm" style="height: 500px;">
              <InteractiveMap markers={markers} />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    function setActiveCard(card) {
      if (!card) return;

      // Update active state visuals
      document.querySelectorAll(".map-card").forEach((c) => {
        c.classList.remove("bg-white", "shadow-md", "ring-1", "ring-stone-300");
      });
      card.classList.add("bg-white", "shadow-md", "ring-1", "ring-stone-300");

      // Scroll card into view only if not fully visible
      const rect = card.getBoundingClientRect();
      const isInViewport =
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth);

      // Only scroll on desktop where side-by-side layout exists (lg breakpoint is 1024px)
      if (!isInViewport && window.innerWidth >= 1024) {
        card.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }

    // Handle map marker selection events from the InteractiveMap component
    document.addEventListener("map-marker-selected", (e) => {
      const { lat, lng } = e.detail;
      const selector = `.map-card[data-lat="${lat}"][data-lng="${lng}"]`;
      const card = document.querySelector(selector);
      setActiveCard(card);
    });

    // Handle card clicks to notify the map
    document.querySelectorAll(".map-card").forEach((card) => {
      const handleClick = (e) => {
        if (e.type === "keydown" && e.key !== "Enter" && e.key !== " ") {
          return;
        }
        if (e.type === "keydown") e.preventDefault();

        // Highlight card
        setActiveCard(card);

        // Notify map to fly to location
        const lat = parseFloat(card.dataset.lat);
        const lng = parseFloat(card.dataset.lng);
        const event = new CustomEvent("fly-to-map", {
          detail: { lat, lng },
        });
        document.dispatchEvent(event);
      };

      card.addEventListener("click", handleClick);
      card.addEventListener("keydown", handleClick);
    });
  });
</script>
